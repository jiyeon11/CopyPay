<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
</head>
<body>
    <button id="basicInfoCheckBtn" class="float-right items-center px-6 py-2 mr-10 mt-3 bg-slate-800 text-md text-white rounded">조회</button><br>
    <div class="flex mt-10 ml-20 pl-20 rounded-lg items-center space-x-2">
        <table class="table-fixed border-collapse mx-auto w-[105rem] h-auto">
            <tbody class="table-row-group">
                <tr class="table-row">
                    <td class="text-center border-2 border-gray-300 bg-gray-200 py-1">
                        <select id="selectMid" class="ml-3 border-2 border-gray-400 outline-none text-base w-24">
                            <option value="MID">MID</option>
                        </select>
                    </td>
                    <td class="border-2 py-1 border-gray-300">
                        <input type="text" id="inputMid" name="mid" class="w-28 h-7 text-sm pl-1 ml-3 border-2 border-gray-400 outline-none">
                    </td>
                    <td class="text-center border-2 border-gray-300 bg-gray-200 py-1">사업체구분</td>
                    <td class="border-2 border-gray-300 py-1">
                        <select id="selectBusinessType" class="ml-3 border-2 border-gray-400 outline-none text-sm w-24">
                            <option value="모두">모두</option>
                            <option value="개인사업자">개인사업자</option>
                            <option value="법인사업자">법인사업자</option>
                        </select>
                    </td>
                </tr>

                <tr class="table-row">
                    <td class="text-center border-2 border-gray-300 bg-gray-200 py-1">사용여부</td>
                    <td class="border-2 border-gray-300 py-1">
                        <select id="selectIsUsed" class="ml-3 border-2 border-gray-400 outline-none text-sm w-24">
                            <option value="모두">모두</option>
                            <option value="사용">사용</option>
                            <option value="사용안함">사용안함</option>
                        </select>
                    </td>
                    <td class="text-center border-2 border-gray-300 bg-gray-200 py-1"><input id="dateOption" type="checkbox" class="ml-2">
                        <label for="dateOption">등록일</label>
                    </td>
                    <td class="border-2 border-gray-300 py-1">
                        <input type="date" id="startDate" min="2013-01-01" max="2032-12-31" class="ml-4 p-2 text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"/>
                        <span class="px-2 text-sm">~</span>
                        <input type="date" id="endDate" min="2013-01-01" max="2032-12-31" class="p-2 text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"/>            
                    </td>
                </tr>

                <tr class="table-row">
                    <td class="text-center border-2 border-gray-300 bg-gray-200 py-1">영중소 사용여부</td>
                    <td class="border-2 border-gray-300 py-1" colspan="3">
                        <select id="selectIsSmallMidUsed" class="ml-3 border-2 border-gray-400 outline-none text-sm w-24">
                            <option value="모두">모두</option>
                            <option value="미사용">미사용</option>
                            <option value="사용">사용</option>
                        </select>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="basicInfoViewList" class="fixed mt-5 ml-10 pl-40 items-center hidden">
        <!-- 조회한 기본정보 리스트 -->
        <div class="bg-white mt-2 rounded-lg shadow-2xl w-[105rem] h-[37rem] overflow-y-auto">
            <table class="w-full table-fixed">
                <thead class="bg-blue-200 sticky top-0 z-10">
                    <tr>
                        <th class="text-center border-r border-blue-400 py-1">사업자번호</th>
                        <th class="text-center border-r border-blue-400 py-1">상호</th>
                        <th class="text-center border-r border-blue-400 py-1">MID</th>
                        <th class="text-center border-r border-blue-400 py-1">사용여부</th>
                        <th class="text-center border-r border-blue-400 py-1">영중소 사용여부</th>
                        <th class="text-center border-r border-blue-400 py-1">등록일</th>
                    </tr>
                </thead>
                <tbody id="list" class="text-sm">
                </tbody>
            </table>
        </div>
        <div class="bg-slate-200 text-center" id="pagination">

        </div>
    </div>

    <script>
        var pageIndex = 1;  //현재 페이지
        $(document).ready(function () {
            var date = new Date();
            date.setMonth(date.getMonth() - 1);

            //조회 버튼 클릭 시
            $("#basicInfoCheckBtn").on('click', function () {
                goPage(pageIndex);
            });
        });

        /**
         * AJAX 요청을 처리하는 공통 함수
         * @param {string} url - 요청 URL
         * @param {string} method - HTTP 메서드
         * @param {object} data - 전송할 데이터 (JSON 형식)
         * @param {function} successCallback - 성공 시 콜백 함수
         * @param {function} errorCallback - 에러 시 콜백 함수
         */
        function makeAjaxCall(url, method, data, successCallback, errorCallback) {
            const token = $("meta[name='_csrf']").attr("content")
            const header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: url,
                method: method,
                data: method !== 'GET' ? JSON.stringify(data) : $.param(data),
                contentType: method !== 'GET' ? 'application/json; charset=utf-8' : undefined,
                beforeSend: function(xhr){  //CSRF 토큰 설정
                    xhr.setRequestHeader(header, token);
                },
                success: function (responseData) {
                    successCallback(responseData);
                },
                error: function (error) {
                    if(errorCallback){
                        errorCallback();
                    }
                    else if(error.responseJSON){
                        const errors = error.responseJSON;
                        //모든 필드의 오류 메시지 초기화
                        $('.error-message').text('');

                        //오류 메시지를 각 필드에 맞게 표시
                        for (const field in errors) {
                            $("p[name=error" + extractFieldName(field)+"]").text(errors[field]);
                        }
                    }
                    else if(!error.responseJSON.message){
                        alert("다시 시도해 주세요.");
                    }
                }
            });
        }
        
        function extractFieldName(field) {  //검증 실패한 필드 이름 추출
            var parts = field.split('.');
            parts = parts.length > 1 ? parts[1] : field; //두 번째 부분 반환
            return parts.charAt(0).toUpperCase() + parts.slice(1);
        }

        function goPage(pageIndex){
            var request = {
                    mid: $('#inputMid').val(),
                    businessType: $('#selectBusinessType').val(),
                    isUsed: $('#selectIsUsed').val(),
                    dateOption: $('input:checkbox[id="dateOption"]').is(":checked"),
                    startDate: $('#startDate').val().replace(/[-/]/g, ''),
                    endDate: $('#endDate').val().replace(/[-/]/g, ''),
                    isSmallMidUsed: $('#selectIsSmallMidUsed').val(),
                    currentPage: pageIndex
                }
            makeAjaxCall('/api/basic-info-view', 'GET', request, function (data) {
                populateTable(data);
            }, showEmptyDataRow());
            $("#basicInfoViewList").removeClass("hidden");
        }

        function populateTable(data) {  //받아온 데이터로 기본 정보 조회 테이블 행 추가
            const tbody = $('#list');
            tbody.empty();
            
            $.each(data.list, function (index, item) {
                const row = `
                            <tr class="even:bg-blue-300 odd:bg-white hover:bg-slate-400">
                                <td class="table-cell px-2 py-1">${formatBusinessRegNumber(item.businessRegNumber)}</td>
                                <td class="table-cell px-2 py-1">${item.businessName}</td>
                                <td class="table-cell px-2 py-1">${item.mid}</td>
                                <td class="table-cell px-2 py-1">${item.isUsed}</td>
                                <td class="table-cell px-2 py-1">${item.isSmallMidUsed}</td>
                                <td class="table-cell px-2 py-1">${formatDate(item.contractDate)}</td>
                            </tr>
                        `;
                tbody.append(row);
            });
            renderPagination(data.pagination);
        }

        function renderPagination(data) {  //페이징
            pageIndex = data.currentPageNo;  //현재 페이지로 변경
            const page = $('#pagination');
            page.empty();
            
            var pagination = `<ol class="inline-flex space-x-2 whitespace-nowrap" id="pagination">`;
            
            if(data.prev){  // 이전 버튼
                pagination += `<li><a href="javascript:void(0);" onclick="goPage(1); return false;" class="px-2 border rounded-lg hover:bg-blue-500 hover:text-white transition duration-200">&lt;&lt;</a></li>`;    
                pagination += `<li><a href="javascript:void(0);" onclick="goPage(${data.currentPageNo - 1}); return false;" class="px-2 border rounded-lg hover:bg-blue-500 hover:text-white transition duration-200">&lt;</a></li>`;
            }
            
            for(var i = data.firstPageNoOnPageList; i <= data.lastPageNoOnPageList; i++) {  // 숫자들
                pagination += `<li><a href="javascript:void(0);" onclick="goPage(${i}); return false;" class="px-2 border rounded-lg hover:bg-blue-500 hover:text-white transition duration-200" id="${i}">${i}</a></li>`;
            }
            
            if(data.next){  // 다음 버튼
                pagination += `<li class="next"><a href="javascript:void(0);" onclick="goPage(${data.currentPageNo + 1}); return false;" class="px-2 border rounded-lg hover:bg-blue-500 hover:text-white transition duration-200">&gt;</a></li>`;  
                pagination += `<li><a href="javascript:void(0);" onclick="goPage(${data.realEnd}); return false;" class="px-2 border rounded-lg hover:bg-blue-500 hover:text-white transition duration-200">&gt;&gt;</a></li>`;
            }
            
            pagination += `</ol>`;
            page.append(pagination);
            $(`#${data.currentPageNo}`).addClass("text-white bg-blue-500");
        }

        function showEmptyDataRow() {  //기본 정보 조회 테이블의 조회 결과가 없을 때
            const tbody = $('#list');
            $('#pagination').empty();
            tbody.empty();
            const noDataRow = `
                            <tr class="table-row">
                                <td class="text-center pt-36" colspan="6">
                                    <p class="text-lg">조회 결과가 없습니다.</p>
                                </td>
                            </tr>
                        `;
            tbody.append(noDataRow);
        }

        function formatBusinessRegNumber(regNumber) {  //사업자번호 xxx-xx-xxxxx 형식으로 바꾸기
            let formatRegNumber = typeof regNumber === 'string' ? regNumber : $(regNumber).val();
            formatRegNumber = formatRegNumber
                .replace(/[^0-9]/g, '')
                .replace(/(\d{3})(\d{2})(\d{5})/, "$1-$2-$3");
            $(regNumber).val(formatRegNumber);
            return formatRegNumber;
        }

        function formatDate(dateString) {  //날짜 YYYY/MM/DD 형식으로 바꾸기
            let year = dateString.substring(0, 4);
            let month = dateString.substring(4, 6);
            let day = dateString.substring(6, 8);
            return year + '/' + month + '/' + day;
        }

    </script>
</body>

</html>